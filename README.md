# microhh_ML
Scripts for NN implemented within MicroHH

## Validation Moser
Contains scripts to plot output of MicroHH and compare to the reference data from Moser

## Training Data
The func_generate_training script takes high resolution binary files (generated by MicroHH) as input and generates netCDF files with corresponding coarse resolution data and unresolved (and total and resolved) turbulent transport.
The order of dimensions in the netCDF file is [time,z,y,x].

If you want to alter the resolution for the coarse data, you need to change the main_training.py, which passess the (z,y,x) dimensions (number of grid cells in z,y,x) to the generate_training_data script. The same function call also specifies whether there are periodic boundary couditions in each direction (a tuple of 3 booleans), zero_w_topbottom is a boolean specifying a boundary condition in Z where the wind speed is 0 as boundary condition (i.e. channel flow). Size_samples is used to define how many ghost cells should be generated.

The generate_samples script cuts the flow field into pieces. Size of the pieces is already stored in the netCDF files (by the func_generate_training script). You can choose to store as netCDF, binary, or both.

## Neural Network
CNN1_estimator.py: contains the network, the tensorflow code etc. Outputs 1 prediction per input sample: the unresolved transport of the e.g. 5x5x5 input sample. In addition to the prediction, the original label is output. These are stored in a netCDF file, in 2 arrays (e.g. element 1 in array 1 is the prediction corresponding to the element 1 in array 2, which contains the label).
job_CNN1_estimater: job script
read_CNNpredictions.py: plots the netCDF array in a scatter plot

## Running the network
E.g.
sbatch job_CNN1_estimater

## Evaluating in TensorBoard
Specify port, e.g.
PORT=40200
tensorboard --logdir=[dir_with_.ckpt-files] --port=$PORT
Then, in local terminal
ssh -N -L port:localhost:port [login]@int1-bb.cartesius.surfsara.nl

## Evaluating output scatter plot
E.g.
python3 read_CNNpredictions.py --prediction_file '/home/casparl/DL4HPC/microhh_ML/runs/checkpoints/synthetic/20190123_150239/CNN_predictions.nc'
read_CNNpredictions.py is located in the Neural Networks directory.
This command will create a number of .png files in the current directory.
